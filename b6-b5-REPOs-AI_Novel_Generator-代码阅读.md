
# Novel_architecture_generate（小说架构生成）

依次调用以下 prompt 生成小说架构：
1. core_seed_prompt：生成核心种子提示，用于确定小说的主题和风格。
2. character_dynamics_prompt：生成角色动力学提示，用于定义角色之间的关系和互动。
3. create_character_state_prompt：在完成角色动力学设定后，依据该角色体系，生成初始角色状态表，并存储到 character_state.txt 文件，后续维护更新。
4. world_building_prompt：生成世界构建提示，用于创建小说的背景和环境。
5. plot_architecture_prompt：生成情节架构提示，用于设计小说的情节和故事线。
6. 结合以上5点生成小说架构。
---
若在中间任何一步报错且重试多次失败，则将已经生成的部分小说架构写入 partial_architecture.json 文件，并退出；下次调用时可从该步骤继续。
最终生成完整的小说架构，并输出到 Novel_architecture.txt 文件中。

## core_seed_prompt：生成核心种子提示，用于确定小说的主题和风格
使用 core_seed_prompt 生成核心种子。该方法接收 topic, genre, number_of_chapters, word_number, user_guidance 等参数

### core_seed_prompt理论方法分析：
1. **雪花写作法应用**：
   - 严格遵循雪花法第一步"一句话概括"的要求
   - 包含所有关键要素：主角、冲突、行动、后果
   - 强调简洁精准（25-100字）符合雪花法原则

2. **故事结构理论**：
   - 显性冲突对应三幕剧的"主要冲突"
   - 潜在危机为后续发展预留空间
   - 人物驱动力确保角色主动性

3. **悬念构建技巧**：
   - "隐藏的更大危机"设置全局悬念
   - 灾难后果创造紧迫感
   - 世界观矛盾暗示未来冲突点

## character_dynamics_prompt：生成角色动力学提示，用于定义角色之间的关系和互动
使用 character_dynamics_prompt 生成角色动力学设定。该方法接收 core_seed, user_guidance 等参数

### character_dynamics_prompt理论方法分析：
1. **角色弧光理论应用**：
   - 完整包含角色弧光的四个阶段（初始→触发→蜕变→最终）
   - 驱动力三角对应K.M.韦兰德的角色维度理论
   - 关系冲突网确保角色互动张力

2. **雪花写作法关联**：
   - 角色设计作为雪花法第二步（角色扩展）
   - 特征细节支持后续情节发展
   - 关系网络构建故事基础架构

3. **悬念构建技巧**：
   - 暗藏秘密创造解谜空间
   - 隐藏背叛可能埋设悬念
   - 价值观冲突推动情节转折

## create_character_state_prompt：在完成角色动力学设定后，依据该角色体系，生成初始角色状态表
使用 create_character_state_prompt 生成初始角色状态表。该方法接收 character_dynamics 参数

### create_character_state_prompt理论方法分析:
1. **角色弧光理论应用**：
   - 完整记录角色发展轨迹（初始→当前状态）
   - 状态描述体现角色成长阶段
   - 事件触发点对应弧光转折节点

2. **雪花写作法关联**：
   - 作为角色维度的动态维护机制
   - 确保角色发展与前期设定一致
   - 为后续创作提供角色行为依据

3. **叙事连贯性保障**：
   - 防止角色能力突变
   - 维持关系变化的合理性
   - 确保物品携带的逻辑性

## world_building_prompt：生成世界构建提示，用于创建小说的背景和环境
使用 world_building_prompt 生成世界观。该方法接收 core_seed, user_guidance 等参数

⚠️ 我认为“世界构建”生成了小说所属的时代背景、小说故事的环境信息，应当在“角色创建”之前完成，并且角色创建时应当使用

### world_building_prompt理论方法分析：
1. **世界构建理论**：
   - 三维度划分（物理/社会/隐喻）符合现代世界构建方法论
   - 动态元素要求确保世界观的可操作性
   - 漏洞点和禁忌设计创造故事可能性空间

2. **雪花写作法关联**：
   - 作为雪花法第三步（世界观扩展）
   - 与核心种子和角色设计形成三角支撑
   - 为后续情节提供环境基础

3. **悬念构建技巧**：
   - 法则漏洞是悬念的天然温床
   - 权力断层线制造冲突悬念
   - 视觉符号系统强化悬念记忆点

## plot_architecture_prompt：生成情节架构提示，用于设计小说的情节和故事线
使用 plot_architecture_prompt 生成情节架构。该方法接收 core_seed, character_dynamics, world_building, user_guidance 等参数

### plot_architecture_prompt理论方法分析：
1. **三幕剧结构深化**：
   - 严格遵循"触发-对抗-解决"的经典结构
   - 各幕关键节点设置符合悉德·菲尔德节拍表
   - 嵌套转折设计增强戏剧性

2. **雪花写作法整合**：
   - 整合前几步成果（核心种子/角色/世界观）
   - 伏笔回收方案体现雪花法的规划性
   - 余波悬念为后续扩展预留空间

3. **悬念三要素应用**：
   - 异常征兆制造信息受限型悬念
   - 虚假胜利强化时间压力型悬念
   - 灵魂黑夜创造危险升级型悬念

## 生成小说架构文件
```
"#=== 0) 小说设定 ===\n"
    f"主题：{topic},类型：{genre},篇幅：约{number_of_chapters}章（每章{word_number}字）\n\n"
    "#=== 1) 核心种子 ===\n"
    f"{core_seed_result}\n\n"
    "#=== 2) 角色动力学 ===\n"
    f"{character_dynamics_result}\n\n"
    "#=== 3) 世界观 ===\n"
    f"{world_building_result}\n\n"
    "#=== 4) 三幕式情节架构 ===\n"
    f"{plot_arch_result}\n"
```

# Chapter_blueprint_generate（章节蓝图生成）
若 Novel_directory.txt 已存在且内容非空，则表示可能是之前的部分生成结果；
    - 解析其中已有的章节数，从下一个章节继续分块生成；
    - 对于已有章节目录，传入时仅保留最近100章目录，避免prompt过长。
否则：
    - 若章节数 <= chunk_size，直接一次性生成
    - 若章节数 > chunk_size，进行分块生成
生成完成后输出至 Novel_directory.txt。

## chunked_chapter_blueprint_prompt：逐步生成章节目录，每次生成会包含已有的章节标题
根据小说架构生成章节目录。该方法接收 novel_architecture, number_of_chapters, user_guidance 等参数，并根据章节数和 chunk_size 决定一次性生成还是分块生成。已有的章节标题只会取自最近100章，避免prompt过长。

### chunked_chapter_blueprint_prompt理论方法分析：
1. **悬念节奏理论**：
   - "悬念单元"设计符合悬念累积-释放的心理学规律
   - 认知过山车模式避免读者疲劳
   - 多视角铺垫增强转折冲击力

2. **雪花写作法应用**：
   - 作为雪花法第六步（扩展大纲）
   - 章节定位与核心种子形成呼应
   - 伏笔操作确保前后连贯

3. **角色弧光整合**：
   - 情感基调迁移反映角色发展
   - 认知颠覆强度匹配角色成长节点
   - 章节定位服务角色塑造

# build_chapter_prompt（章节草稿生成）
构造当前章节的请求提示词（完整实现版）
修改重点：
1. 优化知识库检索流程
2. 新增内容重复检测机制
3. 集成提示词应用规则

## 生成1章节内容的基础流程
1. 获取当前章节信息，在章节目录中已经生成好的基础数据
```
{
    "chapter_number": int,
    "chapter_title": str,
    "chapter_role": str,       # 本章定位
    "chapter_purpose": str,    # 核心作用
    "suspense_level": str,     # 悬念密度
    "foreshadowing": str,      # 伏笔操作
    "plot_twist_level": str,   # 认知颠覆
    "chapter_summary": str     # 本章简述
}
```
2. 获取下一章节信息，在章节目录中已经生成好的基础数据
3. 第1章节的提示词模板：first_chapter_draft_prompt
4. 非第1章节的提示词模板：
    - 使用提示词模板：summarize_recent_chapters_prompt，根据前三章内容生成当前章节的精准前情摘要
    - 使用提示词模板：knowledge_search_prompt，根据章节信息，内容摘要，生成检索关键词组
    - 使用关键词组从向量数据库搜索一些上下文关联信息（这里向量搜索的相关流程需要仔细梳理）
    - 使用提示词模板：next_chapter_draft_prompt完成章节草稿提示词
    - 后续的提示词模板占位符等等处理
5. 在第4步骤中完成的提示词模板展示给用户查看，用户编辑和确认后使用最终的提示词模板生成章节草稿

## first_chapter_draft_prompt：第1章节内容生成
使用到的提示词变量名：novel_number, word_number, chapter_title, chapter_role, chapter_purpose, suspense_level, foreshadowing, plot_twist_level, chapter_summary, characters_involved, key_items, scene_location, time_constraint, user_guidance, novel_setting (在 first_chapter_draft_prompt 中)

### first_chapter_draft_prompt理论方法分析：
1. **场景构建理论**：
   - 四类场景设计（对话/动作/心理/环境）覆盖叙事核心要素
   - 感官描写要求符合"展示而非讲述"原则
   - 动态张力设计增强读者沉浸感

2. **雪花写作法应用**：
   - 整合前期所有设计成果（设定/角色/世界观）
   - 确保与核心种子的一致性
   - 为后续章节建立叙事基准

3. **悬念构建技巧**：
   - 潜台词冲突制造信息差型悬念
   - 异常焦点环境描写铺垫氛围悬念
   - 认知失调表现角色内在悬念

## 非第1章节提示词模板处理的流程
1. 根据前三章内容生成当前章节的精准前情摘要：summarize_recent_chapters_prompt
2. 获取待生成章节的前1一章的结尾内容（用于上下文章节内容衔接流畅）
3. 基于写作需求，生成合适的知识库检索关键词：knowledge_search_prompt


### summarize_recent_chapters_prompt，根据前三章内容生成当前章节的精准前情摘要
1. 获取最新3章节内容，直接组合为一个文本段落combinate_text
2. combinate_text长度最大取4000，超出部分就截断
    - ⚠️ 3章节内容长度组合后，只截取4000的长度，过于短了，我认为过长时，将最新3章节的内容每章节分别生成摘要，再进行组合，既保留了最新3章节的内容，也不至于精准摘要过长。而且，如有必要，改进后的方案可以增加更多的章节作为后续章节的“前情提要”

### summarize_recent_chapters_prompt理论方法分析：
1. **三幕剧结构应用**：
   - 提示词中的"承继→发展→铺垫"三段式结构与三幕剧的"铺垫→对抗→解决"结构高度吻合
   - 70%继承+30%创新的比例分配符合三幕剧对结构平衡的要求
   - 强调与前文逻辑递进，体现了三幕剧对情节连贯性的重视

2. **雪花写作法元素**：
   - 要求从已有内容扩展，符合雪花法"从核心逐步扩展"的理念
   - 对前三章内容的系统回顾体现了雪花法的层次性思维
   - 必继承要素与可调整要素的区分展现了雪花法的结构化特征

3. **悬念构建技巧**：
   - 明确要求处理悬念密度(1-5级)和伏笔操作
   - 提供2种演化方向的要求增加了不确定性
   - 冲突检测机制确保悬念设置的合理性

### knowledge_search_prompt，根据章节信息，内容摘要，生成检索关键词组
- 在构建章节提示词时，会调用知识库检索和处理的逻辑。通过 knowledge_search_prompt 生成检索关键词，然后从向量库中检索相关内容。
- ⚠️ 生成的检索关键词组提示词，更多地生成了内容相关地词组，但是后面的内容分级打标时，使用了固定词组的检测，那么我认为内容分级打标的检测算法很难命中写作技法、设定资料这两个分级。为了更好地内容分级，我认为knowledge_search_prompt应该对这部分做一定地处理

### knowledge_search_prompt理论方法分析：
1. **信息检索理论应用**：
   - 关键词组合逻辑体现信息检索中的"概念组配"原理
   - 优先级规则符合信息检索的"相关度排序"原则
   - 过滤机制应用了信息科学中的"去重"和"抽象度控制"技术

2. **雪花写作法关联**：
   - 关键词生成过程与雪花法的"从核心扩展"理念一致
   - 强调与前文一致性，符合雪花法的连贯性要求
   - 多类型关键词组合支持多层次故事构建

3. **悬念构建技巧**：
   - 事件+后果型关键词直接服务于悬念设置
   - 地点+特征型关键词有助于环境悬念营造
   - 过滤重复内容保证悬念的新鲜感

### 如何生成检索关键词组和相似文本处理
- 从向量库中检索与 query 最相关的 k 条文本，拼接后返回。
- 如果向量库加载/检索失败，则返回空字符串。
- 最终只返回最多2000字符的检索片段。
- 向量数据库的Query文本类似：地下实验室·基因编辑·禁忌实验
    - 返回k段相似文本后，将k段文本进行拼接，并取前2000字符的检索片段
    - ⚠️ 此处的k段相似文本，取了相似的前k段，相似度没有阈值设置，我认为这样避免了可能与Query相似度低的文本无法检索返回相似文本数据，但是缺点在于可能相似度过于低的文本片段会被返回，影响上下文质量
- 基于检索回的检索片段，会在文本前打一个标签：
    - Query文本包含任一：["技法", "手法", "模板"]，生成组合文本 [TECHNIQUE] {context}
    - Query文本包含任一：["设定", "技术", "世界观"]，生成组合文本 [SETTING] {context}
    - 默认规则：生成组合文本 [GENERAL] {context}
    - ⚠️ 与后续的知识库内容应用规则相关，参考next_chapter_draft_prompt提示词，我认为这里的标签使用了英文，LLM对于提示词中的中文描述不一定能对应，为了避免歧义，最好提示词也改为英文
    - 
- 内容规则处理：将检索回的多段检索片段（n个Query文本 * k条相似片段），应用如下规则
    -  首先用正则表达式检查文本中是否包含类似 “第 [数字] 章” 或 “chapter_[数字]” 的章节格式标识。
        - 如果存在这样的标识，通过正则表达式（'\d+'）匹配出文本中所有的数字选取最大的数字作为最近章节号 recent_chap
        - ⚠️ 上下的正则表达式不一致，怀疑是BUG
    - 计算小说编号与最近章节号的时间距离 time_distance（即 novel_number - recent_chap）。
    - 根据时间距离的不同范围进行分类处理：
        - time_distance <= 2，转换为 f"[SKIP] 跳过近章内容：{text[:120]}..."。
        - 3 <= time_distance <= 5，转换为 f"[MOD40%] {text}（需修改≥40%）"。
        - time_distance > 5，转换为 f"[OK] {text}（可引用核心）"。
    - 如果文本中没有包含上述章节标识，转换为 f"[PRIOR] {text}（优先使用）"
    - ⚠️ 各种规则的作用：
        - 知识库内容冲突检测：knowledge_filter_prompt
        - 下一章节内容生成规避和优先级确认：next_chapter_draft_prompt
- 知识过滤：knowledge_filter_prompt
    - 过滤前：知识库使用规则，同样是根据章节号的时间距离处理：
        - <= 3：f"[历史章节限制] 跳过近期内容: {text[:50]}..."
        - 否则：f"[历史参考] {text} (需进行30%以上改写)"
        - 无章节号：f"[外部知识] {text}"
        -  ⚠️ 我认为与上一步骤“内容规则处理”有异曲同工之妙，对每一段内容又做了一次标签标记，但是是否有重复操作的嫌疑？我认为可能与next_chapter_draft_prompt提示词中的冲突检测有一定关联，可能是补丁式的完善。
    - ⚠️ 过滤时看到如下的召回内容默认处理："\n\n".join(formatted_texts) if formatted_texts else "（无检索结果）"，那么之前怀疑过的召回前k段相似文本没有进行相似度的筛选是不太合理的

### knowledge_filter_prompt理论方法分析：
1. **信息处理理论应用**：
   - 三级过滤流程（冲突检测→价值评估→结构重组）符合信息处理的层级模型
   - 重复度阈值(40%)基于认知心理学中的"新颖性感知"研究
   - 分类系统体现了知识管理的"分面分类"原则

2. **雪花写作法关联**：
   - 世界观矛盾检测保障了雪花法的设定一致性
   - 细节锚点要求与雪花法的"逐步扩展"理念吻合
   - 分类重组支持模块化写作

3. **悬念构建技巧**：
   - "情节燃料"分类直接服务于悬念储备
   - 适用场景提示指导悬念类型选择
   - 冲突标记避免悬念设置的自相矛盾

### next_chapter_draft_prompt：完成章节草稿提示词
user_guidance, global_summary, previous_chapter_excerpt, character_state, short_summary, novel_number, chapter_title, chapter_role, chapter_purpose, suspense_level, foreshadowing, plot_twist_level, chapter_summary, word_number, characters_involved, key_items, scene_location, time_constraint, next_chapter_number, next_chapter_title, next_chapter_role, next_chapter_purpose, next_chapter_suspense_level, next_chapter_foreshadowing, next_chapter_plot_twist_level, next_chapter_summary, filtered_context (在 next_chapter_draft_prompt 中)

### next_chapter_draft_prompt理论方法分析：
1. **连续性写作理论**：
   - 多文档参考确保叙事连贯性
   - 章节衔接要求符合"钩子-回应"模式
   - 知识库分级应用体现信息优先级

2. **雪花写作法深化**：
   - 动态整合前期所有设计成果
   - 严格执行冲突检测机制
   - 保持与核心种子的关联性

3. **创新性写作技巧**：
   - 相似度控制避免重复
   - 知识转化要求促进创新
   - 表现手法多样化规定

# finalize_chapter（章节定稿）
对指定章节做最终处理：更新前文摘要、更新角色状态、插入向量库等。
1. 前文摘要更新：summary_prompt，写入global_summary.txt
2. 更新角色状态：update_character_state_prompt，写入character_state.txt
3. 将最新章节文本插入到向量库中
    - 对新的章节文本进行分段后,再用于存入向量库。
    - 使用 embedding 进行文本相似度计算。
    - 固定长度分段：500

## 章节内容扩写
字数较少时，若需要扩写使用额外的prompt扩写
```
以下章节文本较短，请在保持剧情连贯的前提下进行扩写，使其更充实，接近 {word_number} 字左右：
原内容：
{chapter_text}
```
## summary_prompt：前文摘要更新
### 理论方法分析：
1. **信息整合理论**：
   - 遵循"渐进式摘要"原则，逐步累积关键信息
   - 新旧内容融合符合认知心理学中的"知识整合"模型
   - 字数限制强制信息密度优化

2. **雪花写作法关联**：
   - 作为雪花法的"全局视图"维护机制
   - 确保摘要与各层设计保持同步
   - 为后续创作提供一致性检查基准

3. **叙事连贯性保障**：
   - 防止情节逻辑矛盾
   - 维持角色行为一致性
   - 保护世界观设定完整性

## summary_prompt：更新角色状态
```
以下是新完成的章节文本：
{chapter_text}

这是当前的角色状态文档：
{old_state}

请更新主要角色状态，内容格式：
例：
张三：
├──物品:
│  ├──青衫：一件破损的青色长袍，带有暗红色的污渍
│  └──寒铁长剑：一柄断裂的铁剑，剑身上刻有古老的符文
├──能力
│  ├──技能1：强大的精神感知能力：能够察觉到周围人的心中活动
│  └──技能2：无形攻击：能够释放一种无法被视觉捕捉的精神攻击
├──状态
│  ├──身体状态: 身材挺拔，穿着华丽的铠甲，面色冷峻
│  └──心理状态: 目前的心态比较平静，但内心隐藏着对柳溪镇未来掌控的野心和不安
├──主要角色间关系网
│  ├──李四：张三从小就与她有关联，对她的成长一直保持关注
│  └──王二：两人之间有着复杂的过去，最近因一场冲突而让对方感到威胁
├──触发或加深的事件
│  ├──村庄内突然出现不明符号：这个不明符号似乎在暗示柳溪镇即将发生重大事件
│  └──李四被刺穿皮肤：这次事件让两人意识到对方的强大实力，促使他们迅速离开队伍

角色名：
├──物品:
│  ├──某物(道具)：描述
│  └──XX长剑(武器)：描述
│   ...
├──能力
│  ├──技能1：描述
│  └──技能2：描述
│   ...
├──状态
│  ├──身体状态：
│  └──心理状态：描述
│    
├──主要角色间关系网
│  ├──李四：描述
│  └──王二：描述
│   ...
├──触发或加深的事件
│  ├──事件1：描述
│  └──事件2：描述
    ...

......

新出场角色：
- 任何新增角色或临时出场人物的基本信息，简要描述即可，不要展开，淡出视线的角色可删除。

要求：
- 请直接在已有文档基础上进行增删
- 不改变原有结构，语言尽量简洁、有条理

仅返回更新后的角色状态文本，不要解释任何内容。
```

# Character_Import_Prompt：分析当前已有角色的信息
分析create_character_state_prompt（在完成角色动力学设定后，依据该角色体系，生成初始角色状态表，并存储到 character_state.txt）生成的角色信息，导入到角色库中
- 对人类友好的编辑框方式编辑角色信息：新增、更新
- 在其他使用、查看、选择角色的地方，可以快速查看和选择角色

### Character_Import_Prompt理论方法分析：
1. **角色驱动写作理论应用**：
   - 提示词要求提取角色的物品、能力、状态、关系网和触发事件，符合角色驱动写作中构建深度心理档案的要求。
   - 详细的状态描述（身体状态和心理状态）有助于塑造角色的立体感。
   - 关系网的分析强调了角色之间的互动和冲突，符合角色驱动写作中人际关系图谱的建立。

2. **冰山理论元素**：
   - 提示词通过“名称: 描述”的格式，引导AI对角色属性进行精简描述，符合冰山理论中“省略的艺术”的原则。
   - 示例中对物品、能力和事件的描述都较为简洁，留给读者想象空间。
   - 触发事件的分析暗示了角色背后的故事和动机，符合冰山理论中隐藏结构的要求。

3. **悬念构建技巧**：
   - 关系网中“竞争对手”、“盟友”、“暗中培养的继承人”等关系类型，暗示了角色之间的潜在冲突和背叛，有助于制造悬念。
   - 触发事件的描述（如“兵器库遇袭”、“匿名威胁信”）直接服务于悬念设置，引发读者对后续情节的猜测。
   - 物品描述中（如“破损的青色长袍”、“剑身有裂痕”）暗示了角色经历和状态，为后续情节发展埋下伏笔。
